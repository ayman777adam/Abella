<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ‚Ø±ÙŠØ± Ø¥Ø´ØºØ§Ù„ ÙÙ†Ø¯Ù‚ Ø£Ø¨ÙŠÙ„Ø§</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- 1. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª --- */
        :root {
            --bg-body-dark: #1e1e1e;
            --bg-card: #ffffff;
            --text-main: #2d3436;
            --text-sec: #636e72;
            --border-color: #dfe6e9;
            --input-bg: #f1f2f6;
            --primary: #0984e3;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
            --upgrade: #6c5ce7;
            --shadow: 0 10px 20px rgba(0,0,0,0.05);
            --gold-line: rgba(184, 134, 11, 0.15);
        }

        body.dark-mode {
            --bg-card: #2d2d2d;
            --text-main: #dfe6e9;
            --text-sec: #b2bec3;
            --border-color: #444;
            --input-bg: #3a3a3a;
            --shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f9f4e8;
            background-image: 
                linear-gradient(45deg, var(--gold-line) 1px, transparent 1px),
                linear-gradient(-45deg, var(--gold-line) 1px, transparent 1px);
            background-size: 40px 40px;
            background-attachment: fixed;
            color: var(--text-main);
            margin: 0;
            padding: 15px 15px 60px 15px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„ÙÙˆØªØ± Ø§Ù„ØµØºÙŠØ± */
            transition: background-color 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        body.dark-mode {
            background-color: var(--bg-body-dark);
            background-image: none;
        }

        .container { max-width: 500px; margin: 0 auto; }

        /* --- 2. Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯) --- */
        .header-glass {
            background: rgba(255, 255, 255, 0.6); /* Ø´ÙØ§ÙÙŠØ© */
            backdrop-filter: blur(12px); /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            padding: 15px 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        
        body.dark-mode .header-glass {
            background: rgba(45, 45, 45, 0.7);
            border-color: rgba(255,255,255,0.1);
        }

        .header-title h1 { margin: 0; font-size: 1.2rem; color: var(--primary); font-weight: 800; }
        
        .tools-btn {
            background: rgba(255,255,255,0.5);
            border: 1px solid var(--border-color);
            padding: 6px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: 0.2s;
        }
        .tools-btn:hover { background: #fff; transform: scale(1.05); }

        /* --- Dashboard --- */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .card { background: var(--bg-card); border-radius: 16px; padding: 15px; position: relative; box-shadow: var(--shadow); border-bottom: 4px solid transparent; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .card-header { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-sec); margin-bottom: 5px; }
        .info-icon { cursor: pointer; opacity: 0.6; }
        .card-value { font-size: 2rem; font-weight: 800; display: block; line-height: 1; }
        .card-sub { font-size: 0.7rem; opacity: 0.7; margin-top: 5px; display: block; }
        .upgrade-badge { font-size: 0.8rem; background-color: var(--upgrade); color: white; padding: 2px 8px; border-radius: 10px; display: inline-flex; align-items: center; gap: 4px; margin-top: 5px; display: none; }
        .card.stat-ok { border-color: var(--success); color: var(--success); }
        .card.stat-warn { border-color: var(--warning); color: #e1b12c; }
        .card.stat-danger { border-color: var(--danger); color: var(--danger); }

        /* --- Form --- */
        .section { background: var(--bg-card); border-radius: 18px; padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .sec-title { font-weight: 700; color: var(--primary); margin-bottom: 15px; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; font-size: 1rem; }
        .input-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-group { flex: 1; position: relative; min-width: 120px; }
        .input-group label { display: block; font-size: 0.8rem; color: var(--text-sec); margin-bottom: 5px; white-space: nowrap; }
        .input-group input { width: 100%; padding: 12px; border-radius: 12px; border: 2px solid transparent; background-color: var(--input-bg); color: var(--text-main); font-size: 1.2rem; font-weight: bold; text-align: center; box-sizing: border-box; transition: all 0.3s; -moz-appearance: textfield; }
        .input-group input:focus { outline: none; background-color: var(--bg-card); border-color: var(--primary); box-shadow: 0 0 0 4px rgba(9, 132, 227, 0.15); }
        .input-group.error input { border-color: var(--danger); background-color: rgba(214, 48, 49, 0.1); }
        .error-msg { color: var(--danger); font-size: 0.7rem; position: absolute; bottom: -18px; right: 0; display: none; }
        .input-group.error .error-msg { display: block; }

        /* --- Advice & Alerts --- */
        .advice-display-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        .advice-line { padding: 8px; margin: 5px 0; border-radius: 8px; font-weight: 700; font-size: 1rem; }
        .adv-green { background: rgba(0, 184, 148, 0.1); color: var(--success); }
        .adv-red { background: rgba(214, 48, 49, 0.1); color: var(--danger); }
        .alert-box { padding: 15px; border-radius: 12px; margin-top: 15px; text-align: center; font-size: 0.95rem; display: none; }
        .alert-upgrade { background-color: rgba(108, 92, 231, 0.1); color: var(--upgrade); border: 1px solid var(--upgrade); display: block; }

        #submit-btn { width: 100%; padding: 16px; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 800; color: white; background: linear-gradient(135deg, #00b894, #00cec9); cursor: pointer; margin-top: 10px; box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3); transition: filter 0.3s; }
        #submit-btn:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; }

        /* --- Footer (Minimalist) --- */
        .dev-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-card);
            padding: 10px;
            text-align: center;
            font-size: 0.75rem; /* Ø®Ø· ØµØºÙŠØ± */
            color: var(--text-sec);
            border-top: 1px solid var(--border-color);
            z-index: 100;
            white-space: nowrap;
        }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--bg-card); padding: 25px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; }
        .math-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="header-glass">
            <div class="header-title">
                <h1>ØªÙ‚Ø±ÙŠØ± Ø¥Ø´ØºØ§Ù„ ÙÙ†Ø¯Ù‚ Ø£Ø¨ÙŠÙ„Ø§</h1>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="tools-btn" onclick="toggleDarkMode()" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ™</button>
                <button class="tools-btn" onclick="resetData()" title="Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”„</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="card" id="card-single">
                <div class="card-header">
                    <span>Ù…ØªØ§Ø­ Ù„Ù„Ø¨ÙŠØ¹ (Ù…ÙØ±Ø¯)</span>
                    <span class="info-icon" onclick="showExplain('single')">â“</span>
                </div>
                <span class="card-value" id="val-single">0</span>
                <small class="card-sub">Ø³Ø¹Ø©: 4</small>
            </div>

            <div class="card" id="card-suite">
                <div class="card-header">
                    <span>Ù…ØªØ§Ø­ Ù„Ù„Ø¨ÙŠØ¹ (ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©)</span>
                    <span class="info-icon" onclick="showExplain('suite')">â“</span>
                </div>
                <span class="card-value" id="val-suite">0</span>
                <small class="card-sub">Ø³Ø¹Ø©: 20</small>
                <div id="upgrade-badge" class="upgrade-badge">
                    âš¡ ØªØ±Ù‚ÙŠØ© Ù†Ø´Ø·Ø©: <span id="upgrade-count">0</span>
                </div>
            </div>
        </div>

        <form id="main-form">
            <div class="section">
                <div class="sec-title">ğŸ¨ Ø§Ù„Ø¥Ø´ØºØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                <div class="input-row">
                    <div class="input-group" id="grp-stay-s">
                        <label>Ù…Ø¬Ø¯Ø¯/Ø¨Ø§Ù‚ÙŠ (Ù…ÙØ±Ø¯)</label>
                        <input type="number" id="stay-s" placeholder="-" onfocus="this.select()">
                        <span class="error-msg">ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø³Ø¹Ø©!</span>
                    </div>
                    <div class="input-group" id="grp-stay-r">
                        <label>Ù…Ø¬Ø¯Ø¯/Ø¨Ø§Ù‚ÙŠ (ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©)</label>
                        <input type="number" id="stay-r" placeholder="-" onfocus="this.select()">
                        <span class="error-msg">ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø³Ø¹Ø©!</span>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group" id="grp-pot-s">
                        <label>Ù…Ø­ØªÙ…Ù„ Ø®Ø±ÙˆØ¬ (Ù…ÙØ±Ø¯)</label>
                        <input type="number" id="pot-s" placeholder="-" onfocus="this.select()">
                        <div style="font-size:0.6rem; color:var(--text-sec); margin-top:2px;">Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©: 50%</div>
                    </div>
                    <div class="input-group" id="grp-pot-r">
                        <label>Ù…Ø­ØªÙ…Ù„ Ø®Ø±ÙˆØ¬ (ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©)</label>
                        <input type="number" id="pot-r" placeholder="-" onfocus="this.select()">
                        <div style="font-size:0.6rem; color:var(--text-sec); margin-top:2px;">Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©: 50%</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="sec-title">ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© (Ù…Ø¤ÙƒØ¯)</div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Ø¨ÙˆÙƒÙŠÙ†Ø¬ (Ù…ÙØ±Ø¯)</label>
                        <input type="number" id="bk-s" placeholder="-" onfocus="this.select()">
                    </div>
                    <div class="input-group">
                        <label>Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ (Ù…ÙØ±Ø¯)</label>
                        <input type="number" id="rec-s" placeholder="-" onfocus="this.select()">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Ø¨ÙˆÙƒÙŠÙ†Ø¬ (ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©)</label>
                        <input type="number" id="bk-r" placeholder="-" onfocus="this.select()">
                    </div>
                    <div class="input-group">
                        <label>Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ (ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©)</label>
                        <input type="number" id="rec-r" placeholder="-" onfocus="this.select()">
                    </div>
                </div>
            </div>

            <div id="upgrade-alert" class="alert-box alert-upgrade" style="display:none;">
                <b>ğŸš€ Ø§Ù†ØªØ¨Ù‡! ÙŠÙˆØ¬Ø¯ Ø¹Ø¬Ø² ÙÙŠ Ø§Ù„Ù…ÙØ±Ø¯</b><br>
                Ù‚Ù…Ù†Ø§ Ø¨ØªØ±Ù‚ÙŠØ© <span id="alert-upg-count" style="font-weight:800; font-size:1.2rem;">0</span> Ø­Ø¬Ø² Ø¥Ù„Ù‰ ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©.
            </div>

            <div id="final-advice-display" class="advice-display-box"></div>

            <button type="button" id="submit-btn" onclick="sendWhatsApp()">
                Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (WhatsApp) ğŸ“¤
            </button>
        </form>
    </div>

    <div class="dev-footer">
        ØªØ·ÙˆÙŠØ±: Ø§ÙŠÙ…Ù† Ø§Ø¨Ùˆ ÙˆØ±Ø¯Ù‡ | 77aayy@gmail.com
    </div>

    <div id="explain-modal" class="modal-overlay" onclick="closeExplain()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="color:var(--primary); margin-top:0;">ÙƒÙŠÙ ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ</h3>
            <div id="math-content"></div>
            <button onclick="closeExplain()" style="margin-top:15px; background:none; border:1px solid #ccc; padding:5px 15px; border-radius:8px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // --- Ø§Ù„Ø«ÙˆØ§Ø¨Øª ---
        const CAP_S = 4;
        const CAP_R = 20;
        const RISK_S = 0.5; 
        const RISK_R = 0.5; 

        let state = { stayS:0, stayR:0, potS:0, potR:0, bkS:0, recS:0, bkR:0, recR:0 };

        window.onload = function() {
            loadData();
            checkDarkMode();
            setupListeners();
            setupSmartFocus();
            calculateAll();
        };

        function setupListeners() {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', () => { saveData(); calculateAll(); });
            });
        }

        function setupSmartFocus() {
            const inputs = Array.from(document.querySelectorAll('input[type="number"]'));
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextInput = inputs[index + 1];
                        if (nextInput) nextInput.focus();
                        else document.getElementById('submit-btn').focus();
                    }
                });
            });
        }

        // --- Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ ---
        function calculateAll() {
            state.stayS = Number(document.getElementById('stay-s').value) || 0;
            state.stayR = Number(document.getElementById('stay-r').value) || 0;
            state.potS = Number(document.getElementById('pot-s').value) || 0;
            state.potR = Number(document.getElementById('pot-r').value) || 0;
            state.bkS = Number(document.getElementById('bk-s').value) || 0;
            state.recS = Number(document.getElementById('rec-s').value) || 0;
            state.bkR = Number(document.getElementById('bk-r').value) || 0;
            state.recR = Number(document.getElementById('rec-r').value) || 0;

            const validS = validateInput(state.stayS + state.potS, CAP_S, 'grp-stay-s', 'grp-pot-s');
            const validR = validateInput(state.stayR + state.potR, CAP_R, 'grp-stay-r', 'grp-pot-r');
            
            const btn = document.getElementById('submit-btn');
            const adviceDiv = document.getElementById('final-advice-display');

            if (!validS || !validR) {
                btn.disabled = true;
                btn.innerText = "âŒ ØµØ­Ø­ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø³Ø¹Ø©)";
                adviceDiv.innerHTML = "<span style='color:var(--danger)'>ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹</span>";
                return;
            } else {
                btn.disabled = false;
                btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (WhatsApp) ğŸ“¤";
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©
            const gainedS = Math.floor(state.potS * RISK_S);
            const gainedR = Math.floor(state.potR * RISK_R);

            // Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø£ÙˆÙ„ÙŠ
            const physicalS = CAP_S - (state.stayS + state.potS);
            const netS = (physicalS + gainedS) - (state.bkS + state.recS);

            const physicalR = CAP_R - (state.stayR + state.potR);
            const netR = (physicalR + gainedR) - (state.bkR + state.recR);

            // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ±Ù‚ÙŠØ©
            let finalS = netS;
            let finalR = netR;
            let upgradeCount = 0;

            if (netS < 0 && netR > 0) {
                const deficit = Math.abs(netS);
                upgradeCount = Math.min(deficit, netR);
                finalS = netS + upgradeCount;
                finalR = netR - upgradeCount;
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ±ÙˆØª
            updateCard('card-single', 'val-single', finalS);
            updateCard('card-suite', 'val-suite', finalR);

            const badge = document.getElementById('upgrade-badge');
            const alertBox = document.getElementById('upgrade-alert');
            
            if (upgradeCount > 0) {
                badge.style.display = 'inline-flex';
                document.getElementById('upgrade-count').innerText = upgradeCount + " ØºØ±Ù";
                alertBox.style.display = 'block';
                document.getElementById('alert-upg-count').innerText = upgradeCount;
                document.getElementById('val-single').innerText = finalS + " (Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±Ù‚ÙŠØ©)";
            } else {
                badge.style.display = 'none';
                alertBox.style.display = 'none';
            }

            // --- ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø§Ù„Ù†ØµÙŠØ­Ø© ---
            let sAdvice = finalS > 0 ? `<div class="advice-line adv-green">âœ… Ø§ÙØªØ­ Ù…ÙØ±Ø¯ (${finalS})</div>` : `<div class="advice-line adv-red">â›” Ø£ØºÙ„Ù‚ Ù…ÙØ±Ø¯</div>`;
            let rAdvice = finalR > 0 ? `<div class="advice-line adv-green">âœ… Ø§ÙØªØ­ ØºØ±ÙØ© ÙˆØµØ§Ù„Ø© (${finalR})</div>` : `<div class="advice-line adv-red">â›” Ø£ØºÙ„Ù‚ ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©</div>`;
            
            adviceDiv.innerHTML = sAdvice + rAdvice;

            window.calcData = { netS, netR, upgradeCount, gainedS, gainedR, finalS, finalR };
        }

        function validateInput(sum, cap, id1, id2) {
            const el1 = document.getElementById(id1);
            const el2 = document.getElementById(id2);
            if (sum > cap) {
                el1.classList.add('error');
                el2.classList.add('error');
                return false;
            } else {
                el1.classList.remove('error');
                el2.classList.remove('error');
                return true;
            }
        }

        function updateCard(cardId, valId, value) {
            const card = document.getElementById(cardId);
            const valEl = document.getElementById(valId);
            valEl.innerText = value;
            card.classList.remove('stat-ok', 'stat-warn', 'stat-danger');
            if (value > 0) card.classList.add('stat-ok');
            else if (value === 0) card.classList.add('stat-warn');
            else card.classList.add('stat-danger');
        }

        // --- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ---
        function saveData() {
            const data = {};
            document.querySelectorAll('input').forEach(i => data[i.id] = i.value);
            localStorage.setItem('abella_data_v3', JSON.stringify(data));
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('abella_data_v3'));
            if (data) {
                for (const [key, val] of Object.entries(data)) {
                    if(document.getElementById(key)) document.getElementById(key).value = val;
                }
            }
        }

        function resetData() {
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
                document.querySelectorAll('input').forEach(i => i.value = '');
                saveData();
                calculateAll();
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('abella_theme', isDark ? 'dark' : 'light');
        }

        function checkDarkMode() {
            if(localStorage.getItem('abella_theme') === 'dark') document.body.classList.add('dark-mode');
        }

        function showExplain(type) {
            const d = window.calcData;
            const modal = document.getElementById('explain-modal');
            const content = document.getElementById('math-content');
            let html = '';
            if (type === 'single') {
                html = `
                    <div class="math-row"><span>Ø§Ù„Ø³Ø¹Ø© Ø§Ù„ÙƒÙ„ÙŠØ©</span><span>${CAP_S}</span></div>
                    <div class="math-row"><span>(-) Ù…Ø´ØºÙˆÙ„ + Ù…Ø­ØªÙ…Ù„</span><span>${state.stayS + state.potS}</span></div>
                    <div class="math-row"><span>(+) Ù…ÙƒØ³Ø¨ Ù…Ø®Ø§Ø·Ø±Ø©</span><span>${d.gainedS}</span></div>
                    <div class="math-row"><span>(-) Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©</span><span>${state.bkS + state.recS}</span></div>
                    <div class="math-row" style="font-weight:bold; color:var(--primary)"><span>= Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø£ÙˆÙ„ÙŠ</span><span>${d.netS}</span></div>
                    ${d.upgradeCount > 0 ? `<div class="math-row" style="color:var(--upgrade)"><span>(+) ØªØºØ·ÙŠØ© ØªØ±Ù‚ÙŠØ©</span><span>${d.upgradeCount}</span></div>` : ''}
                `;
            } else {
                html = `
                    <div class="math-row"><span>Ø³Ø¹Ø© Ø§Ù„ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©</span><span>${CAP_R}</span></div>
                    <div class="math-row"><span>(-) Ù…Ø´ØºÙˆÙ„ + Ù…Ø­ØªÙ…Ù„</span><span>${state.stayR + state.potR}</span></div>
                    <div class="math-row"><span>(+) Ù…ÙƒØ³Ø¨ Ù…Ø®Ø§Ø·Ø±Ø©</span><span>${d.gainedR}</span></div>
                    <div class="math-row"><span>(-) Ø­Ø¬ÙˆØ²Ø§Øª Ù‚Ø§Ø¯Ù…Ø©</span><span>${state.bkR + state.recR}</span></div>
                    <div class="math-row" style="font-weight:bold; color:var(--primary)"><span>= Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø£ÙˆÙ„ÙŠ</span><span>${d.netR}</span></div>
                    ${d.upgradeCount > 0 ? `<div class="math-row" style="color:var(--upgrade)"><span>(-) Ø®ØµÙ… Ù„Ù„ØªØ±Ù‚ÙŠØ©</span><span>${d.upgradeCount}</span></div>` : ''}
                `;
            }
            content.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closeExplain() { document.getElementById('explain-modal').style.display = 'none'; }

        // --- Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ---
        function sendWhatsApp() {
            const d = window.calcData;
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ar-EG', {hour:'numeric', minute:'numeric', hour12:true});
            
            let upgradeMsg = "";
            if(d.upgradeCount > 0) {
                upgradeMsg = `\n(âš ï¸ ØªÙ… Ø®ØµÙ… ${d.upgradeCount} Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…ÙØ±Ø¯)`;
            }

            const msg = `*ØªÙ‚Ø±ÙŠØ± ÙÙ†Ø¯Ù‚ Ø£Ø¨ÙŠÙ„Ø§ ğŸ¨*
ğŸ•’ ${timeStr}
------------------
ğŸ“Š *Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…ØªØ§Ø­ Ù„Ù„Ø¨ÙŠØ¹)*
â€¢ Ù…ÙØ±Ø¯: *${d.finalS}*
â€¢ ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©: *${d.finalR}* ${upgradeMsg}
------------------
ğŸ“ *Ø§Ù„ØªÙØ§ØµÙŠÙ„*
â€¢ Ø¥Ù‚Ø§Ù…Ø© (Ù…Ø¬Ø¯Ø¯): ${state.stayS} Ù…ÙØ±Ø¯ | ${state.stayR} ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©
â€¢ Ø®Ø±ÙˆØ¬ (Ù…Ø­ØªÙ…Ù„): ${state.potS} Ù…ÙØ±Ø¯ | ${state.potR} ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©
â€¢ Ø­Ø¬ÙˆØ²Ø§Øª (Ù…Ø¤ÙƒØ¯): ${state.bkS + state.recS} Ù…ÙØ±Ø¯ | ${state.bkR + state.recR} ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©
------------------
ğŸ’¡ *Ø§Ù„Ù†ØµÙŠØ­Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©*
1ï¸âƒ£ ${d.finalS > 0 ? 'Ø§ÙØªØ­ Ù…ÙØ±Ø¯ âœ… ('+d.finalS+')' : 'Ø£ØºÙ„Ù‚ Ù…ÙØ±Ø¯ â›”'}
2ï¸âƒ£ ${d.finalR > 0 ? 'Ø§ÙØªØ­ ØºØ±ÙØ© ÙˆØµØ§Ù„Ø© âœ… ('+d.finalR+')' : 'Ø£ØºÙ„Ù‚ ØºØ±ÙØ© ÙˆØµØ§Ù„Ø© â›”'}
`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>
